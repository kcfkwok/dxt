<!DOCTYPE html>
<html lang="{{ get_locale() }}">
  <head>
   <meta charset="UTF-8">
    <link rel="icon" href="static/image/favicon.ico" type="image/x-icon">
    <title>{{ gettext('DongXingTu - Explore') }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 5px;
        }
        #dxt_kz-image {
            margin: 5px;
            border: 1px solid #ccc;
            padding: 5px;
        }
        #dxt_kz-img {
            max-width: 100%;
            max-height: 100%;
        }
        canvas {
            border: 1px solid #000;
            margin-top: 20px;
            max-width: 100%;
            max-height: 100%;
        }
    </style>
    {% include 'styles.html' %}
</head>
<body>
    <a href="{{ url_for('index') }}">{{ gettext('Home') }}</a>
    
    <div style="margin-top: 20px;">
        <label>{{ gettext('Constellation') }}:</label>
        <select id="constellation">
            {% for abbr in csts %}
            <option value="{{ abbr }}" {% if abbr == 'And' %}selected{% endif %}>{{ abbr }} - {{ cstcn[abbr] }}</option>
            {% endfor %}
        </select>
        
        <label style="margin-left: 10px;">{{ gettext('Star') }}:</label>
        <select id="star" disabled>
            <option value="">{{ gettext('-- Select constellation first --') }}</option>
        </select>
        
        <button id="locate-star" style="margin-left: 10px;">{{ gettext('Locate Star') }}</button>
    </div>

    <div style="position: relative; display: inline-block;">
        <canvas id="dxt_kz-canvas" width="800" height="600"></canvas>
        <div id="astro-button" style="position: absolute; width: 400px; height: 80px; 
             background: rgba(0,0,255,0.3); display: none; cursor: pointer; z-index: 100;
             border: 2px solid white; border-radius: 5px;"></div>
    </div>
    <script>
       // Load stars for Andromeda on page load
        document.addEventListener('DOMContentLoaded', function() {
            const constellationSelect = document.getElementById('constellation');
            const starSelect = document.getElementById('star');
            
            if (constellationSelect.value === 'And') {
                starSelect.disabled = false;
                fetch('/get_stars?constellation=And')
                    .then(response => response.json())
                    .then(stars => {
                        starSelect.innerHTML = '';
                        starSelect.add(new Option('{{ gettext("-- Select star --") }}', ''));
                        
                        stars.forEach(star => {
                            let displayName = star.hr_id;
                            if (star.bayer_name) {
                                displayName += ' (' + star.bayer_name + ')';
                            }
                            if (star.chinese_name) {
                                displayName += ' - ' + star.chinese_name;
                            }
                            starSelect.add(new Option(displayName, star.hr_id));
                        });
                    });
            }
        });

        // Main canvas functionality
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('dxt_kz-canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.src = "static/lin_dxt_A4.png";
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
            };
            
            // Mouse down event handler
            canvas.addEventListener('mousedown', function(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);

                const x_left=236;
                const y_up=377;
                const x_right=6694;
                const y_down = 4255;

                if (x < x_right && x > x_left && y > y_up && y < y_down) {
                    // Draw crosshair
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.strokeStyle = 'blue';
                    ctx.lineWidth = 4;
                    ctx.stroke();
                    
                    // Get coordinates and star info
                    fetch('/xy_to_lin_radec', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({x: x, y: y})
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Format RA/Dec coordinates
                        const raH = Math.floor(data.ra/15);
                        const raM = Math.floor((data.ra/15 - raH)*60);
                        const raS = ((data.ra/15 - raH - raM/60)*3600).toFixed(1);
                        
                        const decSign = data.dec >= 0 ? '+' : '-';
                        const decAbs = Math.abs(data.dec);
                        const decD = Math.floor(decAbs);
                        const decM = Math.floor((decAbs - decD)*60);
                        const decS = ((decAbs - decD - decM/60)*3600).toFixed(1);
                        
                        // Display coordinates
                        ctx.font = 'bold 60px Arial';
                        ctx.fillStyle = 'red';
                        let textY = y > canvas.height - 160 ? y - 160 : y;
                        const xx = data.x;
                        const ystep=60;
                        
                        textY +=ystep;
                        const raText = '{{ gettext("RA") }}: ' + raH + 'h ' + raM + 'm ' + raS + 's';
                        const decText = '{{ gettext("Dec") }}: ' + decSign + decD + 'Â° ' + decM + '\' ' + decS+'"';
                        
                        ctx.fillText(raText, xx, textY);
                        textY +=ystep;
                        ctx.fillText(decText, xx, textY);
                        
                        // Display additional info if available
                        textY +=ystep;            
                        if (data.constellation) {
                            const constellationText = '{{ gettext("Constellation") }}: ' + data.constellation;
                            ctx.fillText(constellationText, xx, textY);
                            textY +=ystep;                                        
                        }
                        if (data.bayer_name) {
                            let nearestStarText = '{{ gettext("Nearest Star") }}: ' + data.bayer_name;
                            if (data.hr_id) {
                                nearestStarText = '{{ gettext("Nearest Star") }}: ' + data.hr_id + ' - ' + data.bayer_name;
                            }
                            ctx.fillText(nearestStarText, xx, textY);
                            textY +=ystep;
                        } 
                        if (data.chinese_name) {
                            let chinesenameStarText ='{{ gettext("Chinese Name") }}: ' + data.chinese_name;
                            ctx.fillText(chinesenameStarText, xx, textY);
                            textY +=ystep;
                        }
                        if (data.magnitude) {
                            let magnitudeStarText='{{ gettext("Magnitude") }}: ' + data.magnitude;
                            ctx.fillText(magnitudeStarText, xx, textY);
                            textY +=ystep;
                        }
                        if (data.spectrum) {
                            let spectrumStarText ='{{ gettext("Spectrum") }}: ' + data.spectrum;
                            ctx.fillText(spectrumStarText, xx, textY);
                            textY +=ystep;                            
                        }
                        if (data.distance_ly) {
                            let distanceStarText ='{{ gettext("Distance") }}: ' + data.distance_ly + ' lyr';
                            ctx.fillText(distanceStarText, xx, textY);
                            textY +=ystep;                            
                        }

                        // Position button centered above crosshair
                        const buttonWidth = 100; // Match overlay button width
                        const buttonHeight = 30; // Match overlay button height
                        const buttonX = x - buttonWidth/2; // Center horizontally
                        const buttonY = y - buttonHeight - 10; // Position above crosshair
                        
                        // Draw canvas button (fixed size)
                        //ctx.fillStyle = 'blue';
                        //ctx.fillRect(buttonX, buttonY, buttonWidth, buttonHeight);
                        ctx.fillStyle = 'black'; //'white';
                        ctx.font = 'bold 64px Arial';
                        ctx.fillText('{{ gettext("View Astronomical Image") }}', 
                            buttonX - 320, buttonY -100); // Centered text +10, + 35
                        
                        // Position overlay button div with fixed size
                        const buttonDiv = document.getElementById('astro-button');
                        const fixedWidth = 100; //200; // Fixed width in pixels
                        const fixedHeight = 25; //60; // Fixed height in pixels
                        // Calculate center position accounting for fixed size
                        const canvasRect = canvas.getBoundingClientRect();
                        buttonDiv.style.left = `${(e.clientX - canvasRect.left) - fixedWidth/2}px`;
                        buttonDiv.style.top = `${(e.clientY - canvasRect.top) - fixedHeight + 10}px`;  //-20
                        buttonDiv.style.width = `${fixedWidth}px`;
                        buttonDiv.style.height = `${fixedHeight}px`;
                        buttonDiv.style.display = 'block';
                        buttonDiv.style.pointerEvents = 'auto';
                        console.log('Button positioned at:', 
                            buttonDiv.style.left, buttonDiv.style.top,
                            'with size:', buttonDiv.style.width, buttonDiv.style.height);
                        
                        // Store coordinates for button click
                        canvas.dataset.currentX = x;
                        canvas.dataset.currentY = y;
                        canvas.dataset.currentRa = data.ra;
                        canvas.dataset.currentDec = data.dec;
                        canvas.dataset.currentConstellation = data.constellation;
                        canvas.dataset.currentStar = data.bayer_name || data.hr_id || '';
                        console.log('Stored button coordinates:', 
                            `x=${x} y=${y} buttonX=${buttonX} buttonY=${buttonY}`);
                    });
                }
            });

            // Add click handler for astronomical image button
            const buttonDiv = document.getElementById('astro-button');
            if (!buttonDiv) {
                console.error('Could not find astro-button element');
                return;
            }
            
            console.log('Adding click handler to button div:', buttonDiv);
            console.log('Button div styles:', window.getComputedStyle(buttonDiv));
            
            buttonDiv.addEventListener('click', function(e) {
                console.log('Button div dimensions:', 
                    buttonDiv.offsetWidth, buttonDiv.offsetHeight);
                console.log('Astro button clicked at:', e.clientX, e.clientY);
                console.log('Button position:', buttonDiv.style.left, buttonDiv.style.top);
                console.log('Stored coordinates:', 
                    canvas.dataset.currentRa, canvas.dataset.currentDec);
                
                const ra = canvas.dataset.currentRa;
                const dec = canvas.dataset.currentDec;
                const constellation = canvas.dataset.currentConstellation;
                const star = canvas.dataset.currentStar;

                if (ra && dec) {
                    // Format RA in hms and Dec in dms for API
                    const raH = Math.floor(ra/15);
                    const raM = Math.floor((ra/15 - raH)*60);
                    const raS = ((ra/15 - raH - raM/60)*3600).toFixed(1);
                    const raHms = `${raH}h${raM}m${raS}s`;
                    
                    const decSign = dec >= 0 ? '+' : '-';
                    const decAbs = Math.abs(dec);
                    const decD = Math.floor(decAbs);
                    const decM = Math.floor((decAbs - decD)*60);
                    const decS = ((decAbs - decD - decM/60)*3600).toFixed(1);
                    const decDms = `${decSign}${decD}d${decM}m${decS}s`;
                    
                    // Open new window with astronomical image
                    window.open(`/astronomical_image?ra=${raHms}&dec=${decDms}&name=${encodeURIComponent(star || constellation)}`, '_blank');
                } else {
                    console.log('Button clicked but missing coordinates');
                }
                e.stopPropagation(); // Prevent crosshair from appearing
                e.preventDefault();
                return false;
            });
        });

        // Locate star button click handler
        document.getElementById('locate-star').addEventListener('click', function() {
            const hrId = document.getElementById('star').value;
            if (!hrId) return;

            fetch('/get_star_info?hr_id=' + hrId)
                .then(response => response.json())
                .then(info => {
                    if (info.ra && info.dec && info.cst) {
                        return fetch('/lin_radec_to_xy', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ra: info.ra, dec: info.dec, cst: info.cst, star: info})
                        });
                    }
                    throw new Error('Invalid star coordinates');
                })
                .then(response => response.json())
                .then(coords => {
                    if (coords.x && coords.y && coords.cst && coords.star) {
                        const rect = canvas.getBoundingClientRect();
                        const scaleX = canvas.width / rect.width;
                        const scaleY = canvas.height / rect.height;
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        const x = coords.x;
                        const y = coords.y;
                        const cst = coords.cst;
                        
                        ctx.beginPath();
                        ctx.moveTo(x, 0);
                        ctx.lineTo(x, canvas.height);
                        ctx.moveTo(0, y);
                        ctx.lineTo(canvas.width, y);
                        ctx.strokeStyle = 'blue';
                        ctx.lineWidth = 4;
                        ctx.stroke();
                        
                        const data = coords.star;
                        const raH = Math.floor(data.ra/15);
                        const raM = Math.floor((data.ra/15 - raH)*60);
                        const raS = ((data.ra/15 - raH - raM/60)*3600).toFixed(1);
                
                        const decSign = data.dec >= 0 ? '+' : '-';
                        const decAbs = Math.abs(data.dec);
                        const decD = Math.floor(decAbs);
                        const decM = Math.floor((decAbs - decD)*60);
                        const decS = ((decAbs - decD - decM/60)*3600).toFixed(1);
                
                        ctx.font = 'bold 60px Arial';
                        ctx.fillStyle = 'red';
                        let textY = y > canvas.height - 160 ? y - 160 : y;
                        const xx = x;
                        const ystep=60;
                        
                        textY +=ystep;
                        const raText = '{{ gettext("RA") }}: ' + raH + 'h ' + raM + 'm ' + raS + 's';
                        ctx.fillText(raText, xx, textY);
                        
                        textY +=ystep;
                        const decText = '{{ gettext("Dec") }}: ' + decSign + decD + 'Â° ' + decM + '\' ' + decS+'"';
                        ctx.fillText(decText, xx, textY);
                
                        textY +=ystep;            
                        if (data.constellation) {
                            const constellationText = '{{ gettext("Constellation") }}: ' + data.constellation;
                            ctx.fillText(constellationText, xx, textY);
                            textY +=ystep;                                        
                        }
                        if (data.bayer_name) {
                            let nearestStarText = '{{ gettext("Nearest Star") }}: ' + data.bayer_name;
                            if (data.hr_id) {
                                nearestStarText = '{{ gettext("Nearest Star") }}: ' + data.hr_id + ' - ' + data.bayer_name;
                            }
                            ctx.fillText(nearestStarText, xx, textY);
                            textY +=ystep;
                        } 
                        if (data.chinese_name) {
                            let chinesenameStarText ='{{ gettext("Chinese Name") }}: ' + data.chinese_name;
                            ctx.fillText(chinesenameStarText, xx, textY);
                            textY +=ystep;
                        }
                        if (data.magnitude) {
                            let magnitudeStarText='{{ gettext("Magnitude") }}: ' + data.magnitude;
                            ctx.fillText(magnitudeStarText, xx, textY);
                            textY +=ystep;
                        }
                        if (data.spectrum) {
                            let spectrumStarText ='{{ gettext("Spectrum") }}: ' + data.spectrum;
                            ctx.fillText(spectrumStarText, xx, textY);
                            textY +=ystep;                            
                        }
                        if (data.distance_ly) {
                            let distanceStarText ='{{ gettext("Distance") }}: ' + data.distance_ly + ' lyr';
                            ctx.fillText(distanceStarText, xx, textY);
                            textY +=ystep;                            
                        }
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                });
        });
    </script>
</body>
</html>
